fill='transparent', linetype=1, color='grey30'
) +
geom_point() +
stat_density2d(
aes(fill=..level..),
alpha=.2, geom='polygon'
)
?stat_density2d
nData$boko = ifelse(
nData$a1 == 'Boko Haram' | nData$a2 == 'Boko Haram',
'Event involving Boko Haram', 'Other event'
)
#
nData = nData[!is.na(nData$boko),]
# nData$boko = nData$a1 == 'Boko Haram' | nData$a2 == 'Boko Haram'
ggplot(
data=nData,
aes(
map_id=id,
x=LONGITUDE,
y=LATITUDE
)
) +
inset_ggmap(ngaLines) +
geom_point(
aes(color=boko)
) +
stat_density2d(
aes(fill=..level..),
alpha=.2, geom='polygon'
) +
labs(
x='',
y='',
fill='Level of conflict',
color=''
) +
facet_wrap(~YEAR) +
theme(
axis.text = element_blank(),
legend.position='top'
)
ggplot(
data=nData,
aes(
map_id=id,
x=LONGITUDE,
y=LATITUDE
)
) +
facet_wrap(~YEAR) +
theme(
axis.text = element_blank(),
legend.position='top'
)
?inset_ggmap
class(ngaLines)
ggplot(
data=nData,
aes(
map_id=id,
x=LONGITUDE,
y=LATITUDE
)
) +
inset_ggmap(ngaLines) +
geom_map(map=nigShape,
fill='transparent', linetype=1, color='grey30'
) +
geom_point()
ggplot(
data=nData,
aes(
map_id=id,
x=LONGITUDE,
y=LATITUDE
)
) +
inset_ggmap(ngaLines) +
geom_map(map=nigShape,
fill='transparent', linetype=1, color='grey30'
) +
geom_point() +
stat_density2d(
aes(fill=..level..),
alpha=.2, geom='polygon'
)
?stat_density2d
nigeriaP = ggplot(
data=nData,
aes(
map_id=id,
x=LONGITUDE,
y=LATITUDE
)
) +
inset_ggmap(ngaLines) +
geom_map(map=nigShape,
fill='transparent', linetype=1, color='grey30'
) +
geom_point() +
stat_density2d(
aes(fill=..level..),
alpha=.2, geom='polygon'
)
ggplot_build(nigeriaP)
# lets make boko haram stand out
nData$boko = ifelse(
nData$a1 == 'Boko Haram' | nData$a2 == 'Boko Haram',
'Event involving Boko Haram', 'Other event'
)
#
nData = nData[!is.na(nData$boko),]
# nData$boko = nData$a1 == 'Boko Haram' | nData$a2 == 'Boko Haram'
ggplot(
data=nData,
aes(
map_id=id,
x=LONGITUDE,
y=LATITUDE
)
) +
inset_ggmap(ngaLines) +
geom_point(
aes(color=boko)
) +
stat_density2d(
aes(fill=..level..),
alpha=.2, geom='polygon'
) +
labs(
x='',
y='',
fill='Level of conflict',
color=''
) +
facet_wrap(~YEAR) +
theme(
axis.text = element_blank(),
legend.position='top'
)
?stat_density2d
nigeriaP = ggplot(
data=nData,
aes(
map_id=id,
x=LONGITUDE,
y=LATITUDE
)
) +
inset_ggmap(ngaLines) +
geom_map(map=nigShape,
fill='transparent', linetype=1, color='grey30'
) +
geom_point() +
stat_density2d(
aes(fill=..level..),
alpha=.2, geom='polygon', show.legend = NA
)
nigeriaP
nigShape
class(ngaShape)
class(nigeriaShape)
nigeriaP = ggplot(
data=nData,
aes(map_id=id, x=LONGITUDE, y=LATITUDE)) +
inset_ggmap(ngaLines) +
geom_map(map=nigeriaShape,
fill='transparent', linetype=1, color='grey30') +
geom_point() +
stat_density2d(aes(fill=..level..), alpha=.2, geom='polygon')
nigeriaP
ggplot(
data=nData,
aes(map_id=id, x=LONGITUDE, y=LATITUDE)) +
inset_ggmap(ngaLines) +
geom_point(
aes(color=boko)) +
stat_density2d(aes(fill=..level..), alpha=.2, geom='polygon') +
labs(x='', y='', fill='Level of conflict', color='') +
facet_wrap(~YEAR) +
theme(axis.text = element_blank(), legend.position='top')
library(tidyverse)
library(dplyr)
library(tigris)
library(janitor)
library(sf)
library(scales)
library(tidycensus)
data_dir <- "data"
election_2016 <-
read_csv("data/MEDSL/county-returns/countypres_2000-2016.csv") %>%
filter(year == 2016) %>%
mutate(party = replace_na(party, "other"),
FIPS = formatC(FIPS, digits = 4, format = "d", flag = "0")) %>%
filter(! is.na(state_po))
library(tidyverse)
library(dplyr)
library(tigris)
library(janitor)
library(sf)
library(scales)
library(tidycensus)
data_dir <- "data"
election_2016 <-
read_csv("data/MEDSL/county-returns/countypres_2000-2016.csv") %>%
filter(year == 2016) %>%
mutate(party = replace_na(party, "other"),
FIPS = formatC(FIPS, digits = 4, format = "d", flag = "0")) %>%
filter(! is.na(state_po))
getwd()
setwd("~/Dropbox/teaching/EDA/2020-fall/mod11/maps-fa20")
election_2016 <-
read_csv("data/MEDSL/county-returns/countypres_2000-2016.csv") %>%
filter(year == 2016) %>%
mutate(party = replace_na(party, "other"),
FIPS = formatC(FIPS, digits = 4, format = "d", flag = "0")) %>%
filter(! is.na(state_po))
glimpse(election_2016)
election_2016 <- election_2016 %>%
select(state = state_po, party, county, FIPS, candidatevotes) %>%
pivot_wider(names_from = "party", values_from = "candidatevotes") %>%
filter(! is.na(democrat))
head(election_2016)
state_votes <- election_2016 %>% group_by(state) %>%
summarize_at(vars(democrat, republican, other), ~sum(., na.rm = TRUE)) %>%
ungroup() %>%
mutate(total = democrat + republican + other,
margin = (democrat - republican) / (democrat + republican),
winner = ifelse(democrat > republican, "Clinton", "Trump"))
county_votes <- election_2016 %>%
mutate(total = democrat + republican + other,
margin = (democrat - republican) / (democrat + republican),
winner = ifelse(democrat > republican, "Clinton", "Trump"),
FIPS = ifelse(FIPS == "46113", "46102", FIPS))
head(state_votes)
options(tigris_use_cache = TRUE, tigris_refresh = FALSE)
state_map_file  <- file.path(data_dir, "maps", "state_maps.Rds")
county_map_file <- file.path(data_dir, "maps", "county_maps.Rds")
state_maps <- states(cb = TRUE, year = 2016, progress_bar = FALSE,
class = "sf") %>% clean_names() %>% rename(c("state" = "stusps"))
saveRDS(state_maps, state_map_file)
county_maps <- counties(state = c(state.abb, "DC"), cb = TRUE, year = 2016,
progress_bar = FALSE, class = "sf") %>% clean_names()
saveRDS(county_maps, county_map_file)
glimpse(state_maps)
state_maps <- state_maps %>% inner_join(state_votes, by = "state")
county_maps <- county_maps %>% inner_join(county_votes, by = c(geoid = "FIPS"))
state_votes <- election_2016 %>% group_by(state) %>%
summarize_at(vars(democrat, republican, other), ~sum(., na.rm = TRUE)) %>%
ungroup() %>%
mutate(total = democrat + republican + other,
margin = (democrat - republican) / (democrat + republican),
winner = ifelse(democrat > republican, "Clinton", "Trump"))
county_votes <- election_2016 %>%
mutate(total = democrat + republican + other,
margin = (democrat - republican) / (democrat + republican),
winner = ifelse(democrat > republican, "Clinton", "Trump"),
FIPS = ifelse(FIPS == "46113", "46102", FIPS))
head(state_votes)
options(tigris_use_cache = TRUE, tigris_refresh = FALSE)
state_map_file  <- file.path(data_dir, "maps", "state_maps.Rds")
county_map_file <- file.path(data_dir, "maps", "county_maps.Rds")
state_maps <- states(cb = TRUE, year = 2016, progress_bar = FALSE,
class = "sf") %>% clean_names() %>% rename(c("state" = "stusps"))
saveRDS(state_maps, state_map_file)
county_maps <- counties(state = c(state.abb, "DC"), cb = TRUE, year = 2016,
progress_bar = FALSE, class = "sf") %>% clean_names()
saveRDS(county_maps, county_map_file)
glimpse(state_maps)
state_maps <- state_maps %>% inner_join(state_votes, by = "state")
county_maps <- county_maps %>% inner_join(county_votes, by = c(geoid = "FIPS"))
options(tigris_use_cache = TRUE, tigris_refresh = FALSE)
state_map_file  <- file.path(data_dir, "maps", "state_maps.Rds")
county_map_file <- file.path(data_dir, "maps", "county_maps.Rds")
state_maps <- states(cb = TRUE, year = 2016, progress_bar = FALSE,
class = "sf") %>% clean_names() %>% rename(c("state" = "stusps"))
saveRDS(state_maps, state_map_file)
county_maps <- counties(state = c(state.abb, "DC"), cb = TRUE, year = 2016,
progress_bar = FALSE, class = "sf") %>% clean_names()
saveRDS(county_maps, county_map_file)
glimpse(state_maps)
state_maps <- state_maps %>% inner_join(state_votes, by = "state")
county_maps <- county_maps %>% inner_join(county_votes, by = c(geoid = "FIPS"))
library(tidyverse)
library(dplyr)
library(tigris)
library(janitor)
library(sf)
library(scales)
library(tidycensus)
data_dir <- "data"
election_2016 <-
read_csv("data/MEDSL/county-returns/countypres_2000-2016.csv") %>%
filter(year == 2016) %>%
mutate(party = replace_na(party, "other"),
FIPS = formatC(FIPS, digits = 4, format = "d", flag = "0")) %>%
filter(! is.na(state_po))
glimpse(election_2016)
election_2016 <- election_2016 %>%
select(state = state_po, party, county, FIPS, candidatevotes) %>%
pivot_wider(names_from = "party", values_from = "candidatevotes") %>%
filter(! is.na(democrat))
head(election_2016)
state_votes <- election_2016 %>% group_by(state) %>%
summarize_at(vars(democrat, republican, other), ~sum(., na.rm = TRUE)) %>%
ungroup() %>%
mutate(total = democrat + republican + other,
margin = (democrat - republican) / (democrat + republican),
winner = ifelse(democrat > republican, "Clinton", "Trump"))
county_votes <- election_2016 %>%
mutate(total = democrat + republican + other,
margin = (democrat - republican) / (democrat + republican),
winner = ifelse(democrat > republican, "Clinton", "Trump"),
FIPS = ifelse(FIPS == "46113", "46102", FIPS))
head(state_votes)
options(tigris_use_cache = TRUE, tigris_refresh = FALSE)
state_map_file  <- file.path(data_dir, "maps", "state_maps.Rds")
county_map_file <- file.path(data_dir, "maps", "county_maps.Rds")
state_maps <- states(cb = TRUE, year = 2016, progress_bar = FALSE,
class = "sf") %>% clean_names() %>% rename(c("state" = "stusps"))
saveRDS(state_maps, state_map_file)
county_maps <- counties(state = c(state.abb, "DC"), cb = TRUE, year = 2016,
progress_bar = FALSE, class = "sf") %>% clean_names()
saveRDS(county_maps, county_map_file)
glimpse(state_maps)
state_maps <- state_maps %>% inner_join(state_votes, by = "state")
county_maps <- county_maps %>% inner_join(county_votes, by = c(geoid = "FIPS"))
rlang::last_error()
state_maps
setwd("~/Dropbox/teaching/EDA/2020-fall/mod11/maps-fa20")
library(tidyverse)
library(dplyr)
library(tigris)
library(janitor)
library(sf)
library(scales)
library(tidycensus)
data_dir <- "data"
election_2016 <-
read_csv("data/MEDSL/county-returns/countypres_2000-2016.csv") %>%
filter(year == 2016) %>%
mutate(party = replace_na(party, "other"),
FIPS = formatC(FIPS, digits = 4, format = "d", flag = "0")) %>%
filter(! is.na(state_po))
glimpse(election_2016)
glimpse(election_2016)
election_2016 <- election_2016 %>%
select(state = state_po, party, county, FIPS, candidatevotes) %>%
pivot_wider(names_from = "party", values_from = "candidatevotes") %>%
filter(! is.na(democrat))
head(election_2016)
state_votes <- election_2016 %>% group_by(state) %>%
summarize_at(vars(democrat, republican, other), ~sum(., na.rm = TRUE)) %>%
ungroup() %>%
mutate(total = democrat + republican + other,
margin = (democrat - republican) / (democrat + republican),
winner = ifelse(democrat > republican, "Clinton", "Trump"))
county_votes <- election_2016 %>%
mutate(total = democrat + republican + other,
margin = (democrat - republican) / (democrat + republican),
winner = ifelse(democrat > republican, "Clinton", "Trump"),
FIPS = ifelse(FIPS == "46113", "46102", FIPS))
head(state_votes)
options(tigris_use_cache = TRUE, tigris_refresh = FALSE)
state_map_file  <- file.path(data_dir, "maps", "state_maps.Rds")
county_map_file <- file.path(data_dir, "maps", "county_maps.Rds")
state_maps <- states(cb = TRUE, year = 2016, progress_bar = FALSE,
class = "sf") %>% clean_names() %>% rename(c("state" = "stusps"))
saveRDS(state_maps, state_map_file)
county_maps <- counties(state = c(state.abb, "DC"), cb = TRUE, year = 2016,
progress_bar = FALSE, class = "sf") %>% clean_names()
saveRDS(county_maps, county_map_file)
glimpse(state_maps)
state_maps <- state_maps %>% inner_join(state_votes, by = "stusps")
state_maps <- state_maps %>% inner_join(state_votes, by = "state")
head(state_maps)
---
title: "Mod 11: Maps and Spatial Data"
author: "Dr. Cassy Dorff & Dr. Jonathan Gilligan"
output:
html_document:
keep_md: true
urlcolor: blue
subtitle: DSI-Explore
editor_options:
chunk_output_type: console
---
# Introduction
This is a timely map tutorial written mainly by professor Dr. Jonathan Gilligan at Vanderbilt. He wrote this for our class and I have made modifications to it.
## Overview
We take county-level vote data for the 2016 presidential election from the
[MIT Election Data and Sceince Lab](https://electionlab.mit.edu/) (MEDSL),
which is conveniently available as a `.csv` file at
GitHub: <https://github.com/MEDSL/county-returns>
Throughout this project, we will use FIPS (Federal Information Processing
Standards) codes to identify states, counties, and census tracts. FIPS
codes use two-digit codes to identify each state and territory in the US.
Within each state each county receives a three-digit code and a county is
uniquely identified by a five-digit FIPS code, where the first two digits
identify the state and the next three identify the county.
# Wrangling the data --- OPTIONAL
If you want to test your skills, come back to this part later,
delete everything, and see how you might wrangle the data appropriately.
Otherwise, do not worry too much about the wrangling code. This is hear for you to run. Focus on the maps. I could have just given you cleaned up objects for mapping.
## Wrangling process shown below
1. Load the full election data set from the `.csv` file, and filter to keep
only the rows for 2016 (the full set includes presidential elections from
2008--2016).
2. We have to fix up the FIPS code in the presidential election data
because the `.csv` file from MEDSL represents them as integers,
so state FIPS codes less than 10 are represented by a single-digit and need to
be converted to character data with a leading zero so they will have two digits.
For this task, we use the formatC command.
- The Federal Information Processing Standard Publication 6-4 (FIPS 6-4) was a five-digit Federal Information Processing Standards code which uniquely identified counties and county equivalents in the United States, certain U.S. possessions, and certain freely associated states.
3. Also, the party affiliation of third-party and independent candidates are
represented by `NA`, and we need to convert this to a character value, which
we will set equal to `"other"` using the `tidyverse` function `replace_na()`.
# package loading
```{r}
library(tidyverse)
library(dplyr)
library(tigris)
library(janitor)
library(sf)
library(scales)
library(tidycensus)
data_dir <- "data"
```
First read in the data csv and filter the year for 2016.
Replace those annoying NAs. Reformate FIPS.
```{r load_data, cache = TRUE, cache.extra = c(file.mtime("data/MEDSL/county-returns/countypres_2000-2016.csv"))}
election_2016 <-
read_csv("data/MEDSL/county-returns/countypres_2000-2016.csv") %>%
filter(year == 2016) %>%
mutate(party = replace_na(party, "other"),
FIPS = formatC(FIPS, digits = 4, format = "d", flag = "0")) %>%
filter(! is.na(state_po))
```
Let's take a look at the first few rows of the data frame:
```{r peek_raw_data, cache=TRUE, dependson = "load_data"}
glimpse(election_2016)
```
The original data frame is in a "long" format with one row for each party in
each county, but we want a column with the two-party vote margin, so we
to calculate the margin need to pivot the data frame to a "wide" format with
one row per state and one column for each party:
```{r wrangle_2016_data}
election_2016 <- election_2016 %>%
select(state = state_po, party, county, FIPS, candidatevotes) %>%
pivot_wider(names_from = "party", values_from = "candidatevotes") %>%
filter(! is.na(democrat))
head(election_2016)
```
Next, we add the counties within a state to create a state-level data set.
For both state-level and county-level data, we create three new columns:
`total`, for the total votes cast, `margin` for the margin of victory as a
fraction of the total two-party vote (positive for Democratic victory and
negative for Republican victory), and `winner` indicating the winner in
that state or county.
Finally, a nagging detail we must take care of (data cleaning is very important!):
Shannon County SD (FIPS code 46113) changed its name to Oglala Lakota County
in 2015 and received a new FIPS code (46102), but the MEDSL data files are out
of date and still list it as Shannon County with FIPS code 46113 so we need to
fix this to make it consistent with the map and population data.
```{r state_data, cache=TRUE, dependson="load_data"}
state_votes <- election_2016 %>% group_by(state) %>%
summarize_at(vars(democrat, republican, other), ~sum(., na.rm = TRUE)) %>%
ungroup() %>%
mutate(total = democrat + republican + other,
margin = (democrat - republican) / (democrat + republican),
winner = ifelse(democrat > republican, "Clinton", "Trump"))
county_votes <- election_2016 %>%
mutate(total = democrat + republican + other,
margin = (democrat - republican) / (democrat + republican),
winner = ifelse(democrat > republican, "Clinton", "Trump"),
FIPS = ifelse(FIPS == "46113", "46102", FIPS))
head(state_votes)
```
Now we have the data and we want to get polygons with the shapes of the states
and counties. We use the U.S. Census's TIGR maps, which we get with the
`tigris` package and then we convert them to `sf` ("**simple feature**") data
frames.
**Simple feature** data frames look very much like the `tibble` data frames
you are used to from _R for Data Science_, but they have one special column
called `geometry`, which is treated differently from the other columns.
This column contains the shapes for the _simple features_. Each row can have
a polygon, a set of multiple polygons, a point, a set of points,
or other types of spatial data. Each row can have a different type
of _simple feature_. The term _simple feature_ refers to a formal standard
(ISO 19125-1:2004), that specifies a uniform digital representations
of spatial geometry objects. This specification serves as the basis for
geometrical representations in popular geospatial software inclusing ArcGIS,
the PostGIS database, and the GeoJSON file format.
What is a shape file? (THIS IS REVIEW FROM LECTURE)
- The shapefile format is a geospatial vector data format for geographic information system (GIS) software
- The shapefile format stores the data as primitive geometric shapes like points, lines, and polygons.
- These shapes, together with data attributes that are linked to each shape, create the representation of the geographic data.
- The term "shapefile" is quite common, but the format consists of a collection of files with a common filename prefix, stored in the same directory. The three mandatory files have filename extensions .shp, .shx, and .dbf.
- Use option tigris_use_cache to tell tigris to cache Census shapefile downloads.
```{r load_maps, cache=TRUE, dependson="state_data", message = FALSE}
options(tigris_use_cache = TRUE, tigris_refresh = FALSE)
state_map_file  <- file.path(data_dir, "maps", "state_maps.Rds")
county_map_file <- file.path(data_dir, "maps", "county_maps.Rds")
state_maps <- states(cb = TRUE, year = 2016, progress_bar = FALSE,
class = "sf") %>% clean_names() %>% rename(c("state" = "stusps"))
saveRDS(state_maps, state_map_file)
county_maps <- counties(state = c(state.abb, "DC"), cb = TRUE, year = 2016,
progress_bar = FALSE, class = "sf") %>% clean_names()
saveRDS(county_maps, county_map_file)
glimpse(state_maps)
```
